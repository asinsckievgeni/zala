name: –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ EPG —Å epg.online

on:
  schedule:
    - cron: '0 2 */2 * *'  # –ö–∞–∂–¥—ã–µ 2 –¥–Ω—è –≤ 02:00 UTC (–º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å)
  workflow_dispatch:        # –ö–Ω–æ–ø–∫–∞ "Run workflow" –≤—Ä—É—á–Ω—É—é

jobs:
  update-epg:
    runs-on: ubuntu-latest
    permissions:
      contents: write      # –ù—É–∂–Ω–æ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–ª–∏–∑–æ–≤

    steps:
      - name: üõ† –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —É—Ç–∏–ª–∏—Ç
        run: |
          sudo apt-get update
          sudo apt-get install -y curl

      - name: üîΩ –°–∫–∞—á–∏–≤–∞–Ω–∏–µ EPG –∫–∞–∫ Firefox
        run: |
          curl -L \
            -A "Mozilla/5.0 (X11; Linux x86_64; rv:133.0) Gecko/20100101 Firefox/133.0" \
            -H "Accept: */*" \
            -H "Accept-Language: en-US,en;q=0.9" \
            -H "Accept-Encoding: gzip, deflate, br" \
            -H "Sec-Fetch-Mode: navigate" \
            -H "Sec-Fetch-Site: none" \
            --http2 \
            --connect-timeout 30 \
            --max-time 300 \
            -o epg.xml.gz \
            "https://epg.online/epg.xml.gz"

      - name: üîê –†–∞—Å—á—ë—Ç —Ö—ç—à–∞ —Ç–µ–∫—É—â–µ–≥–æ —Ñ–∞–π–ª–∞
        run: |
          CURRENT_HASH=$(sha256sum epg.xml.gz | cut -d' ' -f1)
          echo "CURRENT_HASH=$CURRENT_HASH" >> $GITHUB_ENV
          echo "$CURRENT_HASH" > current_hash.txt
          echo "–¢–µ–∫—É—â–∏–π —Ö—ç—à: $CURRENT_HASH"

      - name: üì• –ü–æ–ø—ã—Ç–∫–∞ —Å–∫–∞—á–∞—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ö—ç—à –∏–∑ —Ä–µ–ª–∏–∑–∞
        run: |
          gh release download auto-epg -p epg_hash.txt 2>/dev/null || echo "none" > prev_hash.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: üîÑ –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ–ª–∏–∑–∞
        run: |
          if [ ! -f prev_hash.txt ] || [ "$(cat current_hash.txt)" != "$(cat prev_hash.txt)" ]; then
            echo "üÜï –§–∞–π–ª –∏–∑–º–µ–Ω–∏–ª—Å—è ‚Äî —Å–æ–∑–¥–∞—ë–º/–æ–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–ª–∏–∑..."
            echo "${{ env.CURRENT_HASH }}" > epg_hash.txt
            # –ü—ã—Ç–∞–µ–º—Å—è —Å–æ–∑–¥–∞—Ç—å —Ä–µ–ª–∏–∑, –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            gh release create auto-epg epg.xml.gz epg_hash.txt \
              --title "EPG $(date -u +'%Y-%m-%d %H:%M UTC')" \
              --notes "–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å epg.online" 2>/dev/null || \
            # –ò–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π
            gh release upload auto-epg epg.xml.gz epg_hash.txt --clobber
            echo "‚úÖ –†–µ–ª–∏–∑ –æ–±–Ω–æ–≤–ª—ë–Ω!"
          else
            echo "‚úÖ –§–∞–π–ª –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è ‚Äî –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º."
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
